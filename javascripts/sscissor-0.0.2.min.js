var Cluster=function(e,t){var n=this;var r=e.length;var i=3;if(t>r)t=r;n.k=t;n.dimension=i;n.center=[];for(var s=0;s<t;s++){var o=[];for(var u=0;u<i;u++)o.push(Math.random()*255);n.center.push(o)}var a=[];var f=[];for(var s=0;s<r;s++)a.push(0);for(var s=0;s<t;s++)f.push(0);for(var l=0;l<5;l++){for(var s=0;s<t;s++)f[s]=0;var c=0;for(var s=0;s<r;s++){a[s]=n.getNearestCenter(e[s]);f[a[s]]++}for(var s=0;s<t;s++)if(f[s]<=1)n.center[s]=e[parseInt(r*Math.random(),10)];else{n.center[s]=[0,0,0];for(var h=0;h<r;h++)if(a[h]==s)for(var u=0;u<i;u++)n.center[s][u]+=e[h][u];for(var u=0;u<i;u++)n.center[s][u]/=f[s]}}};Cluster.prototype={getNearestCenterDist:function(e){var t=this;if(t.k==0)return 1;var n=t.getNearestCenter(e);return Math.vectorDist(e,t.center[n])},add:function(e){return null},getNearestCenter:function(e){var t=this;if(t.k==0)return NaN;var n=0;var r=Math.vectorDist(e,t.center[0]);for(var i=1;i<t.k;i++){var s=Math.vectorDist(e,t.center[i]);if(s<r){r=s;n=i}}return n}};Math.pointDistToLine=function(e,t,n,r,i,s){var o=(i-n)*(e-n)+(s-r)*(t-r);if(o<=0)return Math.sqrt((e-n)*(e-n)+(t-r)*(t-r));var u=(i-n)*(i-n)+(s-r)*(s-r);if(o>=u)return Math.sqrt((e-i)*(e-i)+(t-s)*(t-s));var a=o/u;var f=n+(i-n)*a;var l=r+(s-r)*a;return Math.sqrt((e-f)*(e-f)+(l-r)*(l-r))};Math.sgn=function(e){if(e<0)return-1;return 1};Math.vectorSub=function(e,t){var n=[];for(var r=0;r<e.length;r++)n.push(e[r]-t[r]);return n};Math.vectorDotProduct=function(e,t){var n=0;for(var r=0;r<e.length;r++)n+=e[r]*t[r];return n};Math.vectorSqrLength=function(e){var t=0;for(var n=0;n<e.length;n++)t+=e[n]*e[n];return t};Math.vectorLength=function(e){var t=0;for(var n=0;n<e.length;n++)t+=e[n]*e[n];return Math.sqrt(t)};Math.vectorDist=function(e,t){return Math.vectorLength(Math.vectorSub(e,t))};var Scissor=function(e){this.canvas=document.getElementById(e);this.width=null;this.height=null;this.offset=null;this.ctx=null;this.imageData=null;this.isMatte=null;this.alpha=null;this.leftBoudary=[];this.rightBoudary=[];this.maxBoudaryArrSize=15;this.brushWidth=15;this.sqrTheata=.1*.1;this.lastX=null;this.lastY=null};Scissor.prototype={start:function(e){var t=this;t.ctx=t.canvas.getContext("2d");var n=new Image;n.src=e;n.onload=function(){t.canvas.width=n.width;t.canvas.height=n.height;t.width=n.width;t.height=n.height;t.canvas.addEventListener("mousedown",i);t.ctx.drawImage(n,0,0);t.imageData=t.ctx.getImageData(0,0,t.width,t.height);t.isMatte=[];t.alpha=[];for(var e=0;e<t.width*t.height;e++){t.isMatte.push(false);t.alpha.push(NaN)}};var r=function(e){var t=e;var n={x:0,y:0};while(t){n.x+=t.offsetLeft;n.y+=t.offsetTop;t=t.offsetParent}if(document.documentElement&&(document.documentElement.scrollTop||document.documentElement.scrollLeft)){n.x-=document.documentElement.scrollLeft;n.y-=document.documentElement.scrollTop}else if(document.body&&(document.body.scrollTop||document.body.scrollLeft)){n.x-=document.body.scrollLeft;n.y-=document.body.scrollTop}else if(window.pageXOffset||window.pageYOffset){n.x-=window.pageXOffset;n.y-=window.pageYOffset}return n};var i=function(e){e.preventDefault();t.offset=r(t.canvas);var n=e.clientX-t.offset.x;var i=e.clientY-t.offset.y;t.lastX=n;t.lastY=i;t.canvas.addEventListener("mousemove",s);t.canvas.addEventListener("mouseup",o)};var s=function(e){e.preventDefault();var n=e.clientX-t.offset.x;var r=e.clientY-t.offset.y;var i=t.lastX;var s=t.lastY;if(n==i&&r==s)return;t.lastX=n;t.lastY=r;var o=n-i,u=r-s;var a=o/Math.sqrt(o*o+u*u),f=u/Math.sqrt(o*o+u*u);var l=0;for(var c=i,h=s;Math.sgn(n-c)==Math.sgn(n-i)&&Math.sgn(r-h)==Math.sgn(r-s);c+=a*2,h+=f*2){l++;var p,d;var v=parseInt(c+f*t.brushWidth,10),m=parseInt(h-a*t.brushWidth,10);if(v<0)v=0;if(m<0)m=0;if(v>=t.width)v=t.width-1;if(m>=t.height)m=t.height-1;p=[];d=4*(m*t.width+v);p.push(t.imageData.data[d+0]);p.push(t.imageData.data[d+1]);p.push(t.imageData.data[d+2]);t.leftBoudary.push(p);if(t.leftBoudary.length>t.maxBoudaryArrSize)t.leftBoudary.shift();var g=parseInt(c-f*t.brushWidth,10),y=parseInt(h+a*t.brushWidth,10);if(g<0)g=0;if(y<0)y=0;if(g>=t.width)g=t.width-1;if(y>=t.height)y=t.height-1;p=[];d=4*(y*t.width+g);p.push(t.imageData.data[d+0]);p.push(t.imageData.data[d+1]);p.push(t.imageData.data[d+2]);t.rightBoudary.push(p);if(t.rightBoudary.length>t.maxBoudaryArrSize)t.rightBoudary.shift()}for(var b=Math.min(n,i)-t.brushWidth;b<Math.max(n,i)+t.brushWidth;b++)for(var w=Math.min(r,s)-t.brushWidth;w<Math.max(r,s)+t.brushWidth;w++)if(w>=0&&w<t.height&&b>=0&&b<t.width&&Math.pointDistToLine(b,w,i,s,n,r)<=t.brushWidth){if(t.isMatte[w*t.width+b]){}else{var E=[],d=4*(w*t.width+b);E.push(t.imageData.data[d+0]);E.push(t.imageData.data[d+1]);E.push(t.imageData.data[d+2]);var S=NaN,x=NaN;for(var T=0;T<t.rightBoudary.length;T++){var N=Math.vectorSqrLength(Math.vectorSub(t.rightBoudary[T],E));if(isNaN(S)||N<S)S=N}for(var C=0;C<t.leftBoudary.length;C++){var N=Math.vectorSqrLength(Math.vectorSub(t.leftBoudary[C],E));if(isNaN(x)||N<x)x=N}var k=NaN,L=NaN;for(var C=0;C<t.leftBoudary.length;C++)for(var T=0;T<t.rightBoudary.length;T++){var A=t.rightBoudary[T],O=t.leftBoudary[C];var M=Math.vectorSub(A,O),_=Math.vectorLength(M);var D=Math.vectorDotProduct(Math.vectorSub(E,O),M)/(_*_);var P=[];P.push(E[0]-(D*A[0]+(1-D)*O[0]));P.push(E[1]-(D*A[1]+(1-D)*O[1]));P.push(E[2]-(D*A[2]+(1-D)*O[2]));var H=Math.vectorLength(P)/_;var B=Math.exp(-Math.vectorSqrLength(Math.vectorSub(A,E))/S),j=Math.exp(-Math.vectorSqrLength(Math.vectorSub(O,E))/x);var F=Math.exp(-H*H*B*j/t.sqrTheata);if(isNaN(k)||F<k){k=F;L=D}}if(L<.5){t.ctx.fillStyle="#FF0000";t.ctx.fillRect(b,w,1,1)}t.alpha[w*t.width+b]=L;t.isMatte[w*t.width+b]=true}}};var o=function(e){e.preventDefault();t.lastX=null;t.lastY=null;t.canvas.removeEventListener("mousemove",s);t.canvas.removeEventListener("mouseup",o)}},finish:function(){var e=this;var t=e.canvas.cloneNode(true);e.canvas.parentNode.replaceChild(t,e.canvas);e.canvas=t;e.ctx=e.canvas.getContext("2d");var n=[],r=[];for(var i=0;i<e.width*e.height;i++)r.push(false);n.push([0,0]);r[0]=true;while(n.length>0){var s=n.shift();var o=s[0],u=s[1];e.imageData.data[(u*e.width+o)*4+3]=0;for(var a=-1;a<=1;a++)for(var f=-1;f<=1;f++){var l=o+a,c=u+f;if(l<0||c<0||l>=e.width||c>=e.height)continue;var h=c*e.width+l;if(r[h]||e.isMatte[h])continue;n.push([l,c]);r[h]=true}}for(var u=0;u<e.height;u++)for(var o=0;o<e.width;o++){var h=u*e.width+o;if(e.isMatte[h]&&e.alpha[h]<=.5)e.imageData.data[h*4+3]=0}e.ctx.putImageData(e.imageData,0,0)}}